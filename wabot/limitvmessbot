#!/bin/bash
# https://t.me/gemilangkinasih

function send_log() {
CHATID=$(cat /root/telebotvpn/idtelegrub)
KEY=$(cat /root/telebotvpn/tokentelebot)
domain=$(cat /etc/xray/domain)
TIME="10"
URL="https://api.telegram.org/bot$KEY/sendMessage"
TEXT="
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ðŸš« Notifikasi Multilogin VMESS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
<code>User  :</code> <code>$akun</code>
<code>Login :</code> <code>$jum2</code>
<code>Limit :</code> <code>$((MAX - 1))</code>
<code>Host  :</code> <code>$domain</code>
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 
Unlock User Otomatis 15 Menit
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ "

curl -s --max-time $TIME -d "chat_id=$CHATID&disable_web_page_preview=1&text=$TEXT&parse_mode=html" $URL >/dev/null
}

data=(`cat /etc/xray/config.json | grep '###' | cut -d ' ' -f 2 | sort | uniq`)
# Loop through each user
for akun in "${data[@]}"; do
    echo -n > /tmp/ipvmessx.txt
    data2=(`cat /var/log/xray/access.log | tail -n 500 | grep email | grep "accepted" | awk -F "from " '{print $2}' | sed 's/tcp://g' | sed 's/\[.*//g' | cut -d: -f1 | sort | uniq`)
    
    # Loop through each IP address and check for usage
    for ip in "${data2[@]}"; do
        jum=$(cat /var/log/xray/access.log | grep -w "$akun" | grep -w "$ip" | grep "accepted" | awk -F "from " '{print $2}' | sed 's/tcp://g' | cut -d ":" -f1 | sort | uniq)
        if [[ "$jum" == "$ip" ]]; then
            echo "$jum" >> /tmp/ipvmessx.txt
        fi
    done
    
    jum=$(cat /tmp/ipvmessx.txt)
    if [[ -n "$jum" ]]; then
         if [ -e "/etc/kyt/limit/vmess/ip/${akun}" ]; then
            iplimit=$(cat /etc/kyt/limit/vmess/ip/${akun})
            MAX=$((iplimit + 1))
        else
            MAX=2
            echo "2" > /etc/kyt/limit/vmess/ip/${akun}
        fi

        if [ "$MAX" -eq 0 ]; then
            MAX=2
            echo "2" > /etc/kyt/limit/vmess/ip/${akun}
        fi
        jum2=$(sort /tmp/ipvmessx.txt | uniq | wc -l)
        echo "Memproses User : [Login: $jum2, Limit: $((MAX - 1))] $akun"
        # Check if the number of logged-in IPs exceeds the limit
        if [ "$jum2" -gt "$MAX" ]; then
            exp=$(grep -w "^### $akun" "/etc/xray/config.json" | cut -d ' ' -f 3 | sort | uniq)
            uuid=$(grep -w "^### $akun $exp" -A 1 "/etc/xray/config.json" | awk -F'"' '/"id":/ {print $4}' | sort | uniq)
            if [[ -z $exp || -z $uuid ]]; then
                continue  # Skip if exp or uuid is empty
            fi
exp=$(grep -wE "^### $akun" "/etc/xray/config.json" | cut -d ' ' -f 3 | sort | uniq)
uuid=$(grep -w "^### $akun $exp" -A 1 "/etc/xray/config.json" | awk -F'"' '/"id":/ {print $4}' | sort | uniq)
uuid2=$(grep -w "^### $akun $exp" -A 1 "/etc/xray/config.json" | awk -F'"' '/"id":/ {print $4}' | sed 's/.*\(LOCKED\)/\1/' | sort | uniq)

if [[ "$uuid2" == "LOCKED" ]]; then
    echo -e "Account $akun has been locked, melewati proses."
    continue
fi

echo "Unlock user $akun dalam 15 menit."
echo "unlocklimitip vmess $akun $exp $uuid" | at now + 15 minutes &> /dev/null
sed -i "/^### $akun $exp/,/^},{/d" /etc/xray/config.json
sed -i "/^### $akun/d" /etc/vmess/.vmess.db
sed -i '/#vmess$/a\### '"$akun $exp"'\
},{"id": "'""$uuid"LOCKED"'","alterId": '"0"',"email": "'""$akun""'"' /etc/xray/config.json
sed -i '/#vmessgrpc$/a\### '"$akun $exp"'\
},{"id": "'""$uuid"LOCKED"'","alterId": '"0"',"email": "'""$akun""'"' /etc/xray/config.json
systemctl restart xray > /dev/null 2>&1
send_log "$akun" "$jum2" "$((MAX - 1)),"

            if [ ${jum2} -gt 5 ]; then
            truncate -s 0 /var/log/xray/access.log
            systemctl restart xray > /dev/null 2>&1;
            fi
        fi
    fi 
    rm -rf /tmp/ipvmessx.txt
    sleep 10
done
sleep 10

# Cleanup
rm -rf /tmp/ipvmessx.txt